<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atendimentos</title>
  <link rel="stylesheet" href="/css/admin/adminStyles.css" />
  <script src="/js/admin/adminScripts.js" defer></script>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <%- include('./partials/sidebarPartialView') %>
    <!-- Main -->
    <main class="main">
      <%- include('./partials/topbarPartialView') %>
      <section class="container">
        <h1 class="h1">Atendimentos</h1>
        <div id="atendimentos-list">
          <% atendimentos.forEach(a => { %>
            <div class="card" style="margin-bottom:1.2rem;">
              <div style="font-weight:bold;font-size:1.1rem;"><%= a.subject %></div>
              <div style="margin-top:.3rem;">
                <b>Contato:</b> <%= a.contato %>
              </div>
              <div style="margin-top:.3rem;">
                <b>Data:</b> <%= a.date ? new Date(a.date).toLocaleDateString('pt-BR') : '-' %>
              </div>
              <div style="margin-top:.3rem;">
                <b>Início:</b> <%= a.start_time || '-' %> &nbsp;
                <b>Fim:</b> <%= a.end_time || '-' %> &nbsp;
                <b>Duração:</b> <%= a.duration_minutes ? a.duration_minutes + ' min' : '-' %>
              </div>
              <div style="margin-top:.7rem;">
                <b>Resumo da conversa:</b>
                <div style="margin-top:.2rem;white-space:pre-line;"><%= a.summary || '-' %></div>
              </div>
              <div style="margin-top:1.2rem;display:flex;flex-direction:column;gap:0.6rem;">
                <a
                  class="btn btn--primary"
                  style="width:100%;justify-content:center;"
                  href="https://wa.me/<%= a.contato_phone ? a.contato_phone.replace(/\D/g,'') : '' %>"
                  target="_blank"
                  <%= a.contato_phone ? '' : 'tabindex="-1" aria-disabled="true" style="pointer-events:none;opacity:.5;"' %>
                >
                  Falar com contato
                </a>
                <a
                  class="btn btn--outline"
                  style="width:100%;justify-content:center;<%= !a.matriculaId ? 'pointer-events:none;opacity:.5;' : '' %>"
                  href="<%= a.matriculaId ? `/admin/matricula/${a.matriculaId}` : '#' %>"
                  <%= !a.matriculaId ? 'tabindex="-1" aria-disabled="true"' : '' %>
                >
                  Matrícula
                </a>
                <a
                  class="btn btn--outline"
                  style="width:100%;justify-content:center;<%= !(a.chatlogLink) ? 'pointer-events:none;opacity:.5;' : '' %>"
                  href="<%= a.chatlogLink || '#' %>"
                  <%= !(a.chatlogLink) ? 'tabindex="-1" aria-disabled="true"' : '' %>
                >
                  Ver conversa
                </a>
              </div>
            </div>
          <% }) %>
        </div>
        <% if (hasMore) { %>
          <div style="text-align:center;margin-top:1.5rem;">
            <button id="btn-load-more" class="btn btn--outline" data-page="1" data-ids="<%= idsParam %>">Carregar mais</button>
          </div>
        <% } %>
      </section>
    </main>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const btn = document.getElementById('btn-load-more');
      if (!btn) return;
      let page = 1;
      const ids = btn.dataset.ids;
      btn.addEventListener('click', function () {
        page++;
        btn.disabled = true;
        btn.textContent = 'Carregando...';
        fetch(`/admin/atendimentos/${ids ? ids : ''}?page=${page}`, { headers: { 'Accept': 'application/json' } })
          .then(res => res.json())
          .then(data => {
            data.atendimentos.forEach(a => {
              const card = document.createElement('div');
              card.className = 'card';
              card.style.marginBottom = '1.2rem';
              card.innerHTML = `
                <div style="font-weight:bold;font-size:1.1rem;">${a.subject}</div>
                <div style="margin-top:.3rem;"><b>Contato:</b> ${a.contato}</div>
                <div style="margin-top:.3rem;"><b>Data:</b> ${a.date ? new Date(a.date).toLocaleDateString('pt-BR') : '-'}</div>
                <div style="margin-top:.3rem;"><b>Início:</b> ${a.start_time || '-'} &nbsp; <b>Fim:</b> ${a.end_time || '-'} &nbsp; <b>Duração:</b> ${a.duration_minutes ? a.duration_minutes + ' min' : '-'}</div>
                <div style="margin-top:.7rem;"><b>Resumo da conversa:</b><div style="margin-top:.2rem;white-space:pre-line;">${a.summary || '-'}</div></div>
                <div style="margin-top:1.2rem;display:flex;flex-direction:column;gap:0.6rem;">
                  <a
                    class="btn btn--primary"
                    style="width:100%;justify-content:center;"
                    href="https://wa.me/${a.contato_phone ? a.contato_phone.replace(/\D/g,'') : ''}"
                    target="_blank"
                    ${a.contato_phone ? '' : 'tabindex="-1" aria-disabled="true" style="pointer-events:none;opacity:.5;"'}
                  >
                    Falar com contato
                  </a>
                  <a
                    class="btn btn--outline"
                    style="width:100%;justify-content:center;${!a.matriculaId ? 'pointer-events:none;opacity:.5;' : ''}"
                    href="${a.matriculaId ? `/admin/matricula/${a.matriculaId}` : '#'}"
                    ${!a.matriculaId ? 'tabindex="-1" aria-disabled="true"' : ''}
                  >
                    Matrícula
                  </a>
                  <a
                    class="btn btn--outline"
                    style="width:100%;justify-content:center;${!a.chatlogLink ? 'pointer-events:none;opacity:.5;' : ''}"
                    href="${a.chatlogLink || '#'}"
                    ${!a.chatlogLink ? 'tabindex="-1" aria-disabled="true"' : ''}
                  >
                    Ver conversa
                  </a>
                </div>
              `;
              document.getElementById('atendimentos-list').appendChild(card);
            });
            if (data.hasMore) {
              btn.disabled = false;
              btn.textContent = 'Carregar mais';
            } else {
              btn.remove();
            }
          })
          .catch(() => {
            btn.disabled = false;
            btn.textContent = 'Carregar mais';
          });
      });
    });
  </script>
</body>
</html>
