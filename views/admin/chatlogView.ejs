<%- include('./partials/headPartialView') %>
<%- include('./partials/headerPartialView') %>

<main class="content">
<article class="card block" id="mensagens">
  <header class="block__head">
    <div>
      <h3 class="block__title">Mensagens</h3>
      <p class="block__subtitle">Conversa com o contato</p>
    </div>
  </header>

  <!-- Busca de contato -->
  <form class="searchbox msg-filter" role="search" onsubmit="return false" autocomplete="off">
    <div class="search-row">
      <div class="search-field" style="position:relative;">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor"
            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zm-6 0A4.5 4.5 0 1 1 14 9.5 4.505 4.505 0 0 1 9.5 14Z"/>
        </svg>
        <input class="search-input" id="contact-search" type="search"
               placeholder="Pesquisar por nome..."
               aria-label="Pesquisar mensagens" autocomplete="off" />
        <ul id="autocomplete-list" style="position:absolute;left:0;right:0;top:110%;z-index:10;background:var(--surface,#171a21);border-radius:10px;box-shadow:0 4px 16px #0002;list-style:none;margin:0;padding:0;display:none;"></ul>
      </div>
      <button class="btn btn--primary-soft" type="submit" tabindex="-1" style="display:none;">Buscar</button>
    </div>

    <% if (contact && dp && dp.hasData) { %>
      <!-- Datepicker SSR (links reais) -->
      <div class="date-picker" id="datepicker-wrap" style="opacity:1;">
        <div class="date-picker__head" style="align-items:center;">
          <div style="display:flex;align-items:center;gap:12px;">
            <% if (dp.hasPrev) { %>
              <a class="date-btn" href="/admin/chatlogs/<%= userId %>?month=<%= dp.prevMonth %>" aria-label="Mês anterior">‹</a>
            <% } else { %>
              <button class="date-btn" type="button" disabled aria-disabled="true">‹</button>
            <% } %>

            <h4 class="date-picker__title" id="month-title" aria-live="polite"><%= dp.label %></h4>

            <% if (dp.hasNext) { %>
              <a class="date-btn" href="/admin/chatlogs/<%= userId %>?month=<%= dp.nextMonth %>" aria-label="Próximo mês">›</a>
            <% } else { %>
              <button class="date-btn" type="button" disabled aria-disabled="true">›</button>
            <% } %>
          </div>

          <div class="date-head-actions">
            <a class="btn btn--primary-soft" href="/admin/chatlogs/<%= userId %>">Todas mensagens</a>
          </div>
        </div>

        <div class="date-picker__weekdays" aria-hidden="true">
          <span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>Sáb</span>
        </div>

        <div class="date-picker__grid" role="grid" aria-label="Selecione uma data">
          <% for (let i = 0; i < dp.firstWeekday; i++) { %>
            <button class="dp-day is-disabled" type="button" disabled>&nbsp;</button>
          <% } %>

          <% for (let d = 1; d <= dp.daysInMonth; d++) { 
               const info = dp.days[d-1]; %>
            <% if (info && info.active) { %>
              <a class="dp-day is-active" href="/admin/chatlogs/<%= userId %>/<%= info.ids.join(',') %>"><%= d %></a>
            <% } else { %>
              <button class="dp-day is-disabled" type="button" disabled><%= d %></button>
            <% } %>
          <% } %>
        </div>

        <p class="picker-context" id="picker-context">Exibindo conversa com: <strong id="selected-contact-name"><%= contact.contactname %></strong></p>
      </div>
    <% } %>
  </form>

  <!-- Conversa (SSR) -->
  <section class="chat" aria-live="polite" id="chat-messages">
    <% if (messages && messages.length) { %>
      <% var lastDay = null; %>
      <% messages.forEach(function(m){ 
           var day = new Date(m.time).toLocaleDateString('pt-BR');
           if (day !== lastDay) { %>
             <div class="chat__day"><%= day %></div>
           <% lastDay = day; } %>

        <% if (m.usermessage) { %>
          <div class="msg msg--in">
            <p class="msg__text"><%= m.usermessage %></p>
            <span class="msg__time"><%= new Date(m.time).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' }) %></span>
          </div>
        <% } %>
        <% if (m.agentresponse) { %>
          <div class="msg msg--out">
            <p class="msg__text"><%= m.agentresponse %></p>
            <span class="msg__time"><%= new Date(m.time).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' }) %></span>
          </div>
        <% } %>

      <% }) %>
    <% } else if (contact) { %>
      <div style="text-align:center;color:var(--muted);padding:2rem;">Nenhuma mensagem encontrada.</div>
    <% } else { %>
      <div style="text-align:center;color:var(--muted);padding:2rem;">Busque um contato para visualizar as mensagens.</div>
    <% } %>
  </section>


</article>
</main>

<!-- Botão hambúrguer (mobile) -->
<label for="nav-toggle" class="hamburger" aria-label="Abrir menu" title="Abrir menu">
  <span></span><span></span><span></span>
</label>
<label for="nav-toggle" class="overlay" aria-hidden="true"></label>

<script src="/js/admin/chatlogScripts.js"></script>
<script src="/js/admin/adminGlobalScripts.js"></script>
</body>
</html>
